<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>december adventure 2023 - gb</title>
        <link rel="stylesheet" href="style/style.css">
        <meta name="description" content="">
    </head>
    <body>
        <header>
            <nav>
                <div id="home-link">
                    <a href="/">gb</a>
                </div>
                <div id="navtree"><ul>
	<li><a href=projects.html>projects</a></li>
	<li><a href=explorations.html>explorations</a></li>
	<li><a href=notes.html class="active">notes</a></li>
	<li><a href=about.html>about</a></li>
</ul>
<ul>
	<li><a href=hardware_notes.html>hardware</a></li>
	<li><a href=software_notes.html>software</a></li>
	<li><a href=play.html>play</a></li>
	<li><a href=december_adventure_2023.html class="active">december adventure 2023</a></li>
	<li><a href=craft.html>craft</a></li>
	<li><a href=maths.html>maths</a></li>
</ul>
</div>

            </nav>
        </header>
        <main>
            <section id="main-content">
                
                <article>
                <h1 id="title">december adventure 2023</h1>
                    <p>This year I decided to go on a <a class="outgoing" href="https://eli.li/december-adventure">December Adventure</a>, where I try to work on a project a little bit every day of december.</p>
<p>My goal is to bridge the <em>abstraction gap</em> by learning to write programs in C. As a learning project, I'm building a 3D engine/projector inspired by <a class="outgoing" href="https://wiki.xxiivv.com/site/moogle.html">moogle</a> and <a class="outgoing" href="https://git.sr.ht/~bellinitte/pinhole">pinhole</a> (I technically began working on it in november, but that's what I have going on at the moment so I'll roll with it).</p>
<p><a class="outgoing" href="https://github.com/GhettoBastler/3D-projector">Link to GitHub repository</a></p>
<h1>Log</h1>
<h2>10</h2>
<p>Today was mostly cleanup and refactoring. I'm not really sure about the way I've split up the code, but I'm keeping myself from doing too much rewriting as there are still things I want to implement.</p>
<p><a class="outgoing" href="https://fosstodon.org/deck/@axwax@chaos.social/111550544682033846">A comment from AxWax on the Fediverse</a> made me discover Elite, a 1984 classic game for the BBC Micro which uses wireframe graphics, and whose source code has been <a class="outgoing" href="https://www.bbcelite.com/">thoroughly documented</a>.</p>
<p>This led me to learn about back face culling, a technique for hiding the back faces of wireframe meshes which makes them look more "solid". I'm tempted to implement it, but this would imply changing the way I store 3D models, which would mean rewriting all of the code for the primitives. </p>
<p>Finally, I added <a class="outgoing" href="https://ghettobastler.com/c.html">a new page</a> for the notes I'm taking while working on this project.</p>
<h2>09</h2>
<p>
<video controls=""><source src="media/da2023_0912.mp4" type="video/mp4"></source></video>
</p>
<p>Finally solved the CPU usage issues! To understand, here is what my program does at each frame:</p>
<ol>
<li>Apply 3D transforms to the model</li>
<li>Project the edges onto a 2D plane</li>
<li>Apply Bresenham's line algorithm to draw the 2D lines on screen</li>
</ol>
<p>The problem arose when one or both ends of an edge came close to the camera center:</p>
<ul>
<li>Since the 2D coordinates are <a class="outgoing" href="https://en.wikipedia.org/wiki/3D_projection#Diagram">proportional to the inverse of the distance</a> between the object and the camera, the resulting projected edge would in some cases become extremely long.</li>
<li>But Bresenham's line algorithm draws a line one pixel at a time. Specifically, for implementation used by SDL, the longer the line, the more memory it tries to allocate.</li>
</ul>
<p>Therefore the first version of my program would crash when the OS ran out of memory to allocate.</p>
<p>My first solution was to reimplement Bresenham's algorithm. This didn't really fix the memory problem rather than turn it into a CPU usage one: while my program stopped requesting more memory than the OS could provide, it would instead spend ages drawing an excessively long line one pixel at a time.</p>
<p>The solution I implemented today was simpler: cut the lines where the screen ends. <em>Duh</em>. As expected, this dramatically improved the performances which allowed more fluidly inside the scene. Hurray!</p>
<p>I felt good, so I also spent a little time rewriting the controls so I could use the "ZQSD" keys (the French "WASD") to move around.</p>
<p>Good day!</p>
<h2>08</h2>
<p>
<video controls=""><source src="media/da2023_0812.mp4" type="video/mp4"></source></video>
</p>
<p>Rotations in the previous version were centered around the origin of the scene, which felt weird when the camera wasn't centered at the origin. After implementing homogeneous coordinates, it was easier to switch things around and have the rotations centered at the camera, which seems more natural. I still have to fix some CPU usage issue that comes from lines being too long when projected.</p>
<h2>07</h2>
<p>I was looking for a better way to calculate transforms (translation and rotation), so I learned about <a class="outgoing" href="https://en.wikipedia.org/wiki/Transformation_matrix#Affine_transformations">homogeneous coordinates</a>, with allows one to encode rotation and translation in a transformation matrix. This appears to be a cleaner way to calculate point transformations, but I will have to wait until tomorrow to try.</p>
<h2>06</h2>
<p>Not much to show today. After putting my code online, I got self conscious and started rewriting everything to try and make it look <em>pretty</em>. The problem is: I have no idea what <em>pretty C code</em> looks like (if there is even such a thing). As you can guess, having such a hazy goal only brought me frustration and, after an hour of rewriting the same file over and over again, I decided to call it a day.</p>
<p>What did I learn from this ? Well, that while having a lot of experience writing Python code, I'm still a beginner when it comes to C. This means that my code <em>will</em> be messy, and <strong>this is fine</strong>. My goal is to learn, so I should focus on exploring ideas and getting things to work, all while developping a better understanding of the language (case in point: I still have no clue about how scope works).</p>
<p>An interesting and somewhat related read: <a class="outgoing" href="https://www.ratfactor.com/cards/dumb-first">"Do it the dumb way first"</a> by Dave Gauer.</p>
<h2>05</h2>
<p><img alt="" src="media/da2023_0512.jpg" /></p>
<p>I continued splitting things into smaller files. I now understand the point of header files: they store function <em>declaration</em> so the compiler can tell you when you mess up without needing the whole function <em>definition</em> (which you might not even have access to). I think.</p>
<p>Also, my messy code is now in <a class="outgoing" href="https://github.com/GhettoBastler/3D-projector">a GitHub repository</a>.</p>
<h2>04</h2>
<p>Didn't add anything new today, but I did some cleanup and split my code into smaller files. Thus, I learned about header files which, coming from Python, did not make sense to me (why two separate files ?). It works now, but I think I'll still have to play with it to really wrap my head around it.</p>
<p>I still have some cleanup to do for tomorrow, but eventually I'd like to add some other primitives and/or look into reading input files.</p>
<h2>03</h2>
<p><img alt="" src="media/da2023_0312.jpg" /></p>
<p>As expected, <a class="outgoing" href="https://stackoverflow.com/questions/76861004/memory-leak-in-c-program-using-sdl2">someone on StackOverflow</a> had the same exact problem: turns out the SDL_RenderDrawLine doesn't like it when you tell it to draw extremely long lines. So when an edge ends up between the camera and the focal plane, its projection on the focal plane can become very long. This makes SDL try to allocate more and more memory to draw the entire line, until it can't anymore and crashes.</p>
<p>An easy fix suggested by the top answer was to tell SDL to use another method to to draw lines, which works, but that led me to wanting to learn about line drawing algorithms.
I ended up reimplementing <a class="outgoing" href="https://en.wikipedia.org/wiki/Bresenham%27s_line_algorithm">Bresenham's algorithm</a>. So now my program doesn't take up all of the available memory, and I have an array of bytes containing the pixel data that I could export directly as an image.</p>
<h2>02</h2>
<p>Today I learned that the word I had to search for in order to fix my problem was "profiling".</p>
<p>I added a new target with the relevant options to my Makefile, learned about gprof, and discovered that I was recalculating the whole the rotation matrix <em>for every single vertex</em> of the model. As a fix, I used an array to store the matrix values, updated it only once per frame, aaand... I'm still getting performance issues. I'll have to investigate this further tomorrow.</p>
<h2>01</h2>
<p><img alt="" src="media/da2023_0112.jpg" /></p>
<p>I already have a few 3D primitives working, so today I added a simple "grid" function which draw a 2D plane. This led me to realize that my program starts lagging severely when the grid is too large.</p>
                </article>
            </section>
                
        </main>
        <footer>
            <div id="footer-links">
                <a href="https://webring.xxiivv.com/#ghettobastler" target="_blank" rel="noopener">
                    <img class="footer-img" src="webring-logo.svg" alt="XXIIVV webring"/>
                </a>
                <a href="https://github.com/GhettoBastler">
                    <img class="footer-img" src="github-logo.svg" alt="GitHub page">
                </a>
                <a rel="me" href="https://fosstodon.org/@ghettobastler">
                    <img class="footer-img" src="fedi-logo.svg" alt="Mastodon profile">
                </a>
            </div>
            <a id="cc-link" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>
        </footer>
    </body>
</html>
